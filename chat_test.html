<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠå¤©åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e9ecef;
            border-radius: 10px;
        }
        
        .test-section h3 {
            color: #495057;
            margin-bottom: 15px;
        }
        
        .status {
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .test-button:hover {
            background: #0056b3;
        }
        
        .test-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .log-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .input-group input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª èŠå¤©åŠŸèƒ½æµ‹è¯•å·¥å…·</h1>
        
        <div class="test-section">
            <h3>1. DifyæœåŠ¡è¿æ¥æµ‹è¯•</h3>
            <div id="dify-status" class="status warning">
                â³ ç­‰å¾…æµ‹è¯•...
            </div>
            <button class="test-button" onclick="testDifyConnection()">æµ‹è¯•Difyè¿æ¥</button>
            <button class="test-button" onclick="testDifyEmbed()">æµ‹è¯•DifyåµŒå…¥</button>
        </div>
        
        <div class="test-section">
            <h3>2. åç«¯APIæµ‹è¯•</h3>
            <div id="api-status" class="status warning">
                â³ ç­‰å¾…æµ‹è¯•...
            </div>
            <div class="input-group">
                <input type="text" id="test-message" placeholder="è¾“å…¥æµ‹è¯•æ¶ˆæ¯..." value="ä½ å¥½ï¼Œè¯·æ¨èæˆ¿é—´">
                <button class="test-button" onclick="testBackendAPI()">æµ‹è¯•åç«¯API</button>
            </div>
        </div>
        
        <div class="test-section">
            <h3>3. å‰ç«¯é¡µé¢æµ‹è¯•</h3>
            <div id="frontend-status" class="status warning">
                â³ ç­‰å¾…æµ‹è¯•...
            </div>
            <button class="test-button" onclick="testFrontendPage()">æ‰“å¼€AIé€‰æˆ¿é¡µé¢</button>
            <button class="test-button" onclick="checkPageElements()">æ£€æŸ¥é¡µé¢å…ƒç´ </button>
        </div>
        
        <div class="test-section">
            <h3>4. æµ‹è¯•æ—¥å¿—</h3>
            <div id="log-area" class="log-area">ç­‰å¾…æµ‹è¯•å¼€å§‹...\n</div>
            <button class="test-button" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
    </div>

    <script>
        function log(message) {
            const logArea = document.getElementById('log-area');
            const timestamp = new Date().toLocaleTimeString();
            logArea.textContent += `[${timestamp}] ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log-area').textContent = '';
        }
        
        function updateStatus(elementId, type, message) {
            const element = document.getElementById(elementId);
            element.className = `status ${type}`;
            element.textContent = message;
        }
        
        async function testDifyConnection() {
            log('å¼€å§‹æµ‹è¯•DifyæœåŠ¡è¿æ¥...');
            updateStatus('dify-status', 'warning', 'â³ æ­£åœ¨æµ‹è¯•Difyè¿æ¥...');
            
            try {
                const response = await fetch('http://47be5268.r28.cpolar.top/embed.min.js', {
                    method: 'HEAD',
                    mode: 'no-cors'
                });
                
                log('DifyåµŒå…¥è„šæœ¬å¯è®¿é—®');
                updateStatus('dify-status', 'success', 'âœ… DifyæœåŠ¡è¿æ¥æ­£å¸¸');
                
                // æµ‹è¯•ç›´æ¥è°ƒç”¨ç«¯ç‚¹
                const chatResponse = await fetch('http://47be5268.r28.cpolar.top/chat/fggmGdSFt6MSQFJa', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: 'æµ‹è¯•è¿æ¥',
                        response_mode: 'streaming',
                        user: 'test-user'
                    })
                });
                
                if (chatResponse.ok) {
                    log('DifyèŠå¤©ç«¯ç‚¹å“åº”æ­£å¸¸');
                } else {
                    log(`DifyèŠå¤©ç«¯ç‚¹å“åº”å¼‚å¸¸: ${chatResponse.status}`);
                }
                
            } catch (error) {
                log(`Difyè¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`);
                updateStatus('dify-status', 'error', 'âŒ DifyæœåŠ¡è¿æ¥å¤±è´¥');
            }
        }
        
        async function testDifyEmbed() {
            log('å¼€å§‹æµ‹è¯•DifyåµŒå…¥åŠŸèƒ½...');
            
            // è®¾ç½®Difyé…ç½®
            window.difyChatbotConfig = {
                token: 'fggmGdSFt6MSQFJa',
                baseUrl: 'http://47be5268.r28.cpolar.top'
            };
            
            // åŠ¨æ€åŠ è½½Difyè„šæœ¬
            const script = document.createElement('script');
            script.src = 'http://47be5268.r28.cpolar.top/embed.min.js';
            script.id = 'fggmGdSFt6MSQFJa';
            script.defer = true;
            
            script.onload = () => {
                log('DifyåµŒå…¥è„šæœ¬åŠ è½½æˆåŠŸ');
                updateStatus('dify-status', 'success', 'âœ… DifyåµŒå…¥åŠŸèƒ½æ­£å¸¸');
            };
            
            script.onerror = () => {
                log('DifyåµŒå…¥è„šæœ¬åŠ è½½å¤±è´¥');
                updateStatus('dify-status', 'error', 'âŒ DifyåµŒå…¥åŠŸèƒ½å¤±è´¥');
            };
            
            document.head.appendChild(script);
        }
        
        async function testBackendAPI() {
            const message = document.getElementById('test-message').value;
            log(`å¼€å§‹æµ‹è¯•åç«¯APIï¼Œæ¶ˆæ¯: ${message}`);
            updateStatus('api-status', 'warning', 'â³ æ­£åœ¨æµ‹è¯•åç«¯API...');
            
            try {
                const response = await fetch('http://localhost:8080/chat/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: message,
                        response_mode: 'streaming',
                        user: 'test-user'
                    })
                });
                
                if (response.ok) {
                    log('åç«¯APIå“åº”æ­£å¸¸');
                    updateStatus('api-status', 'success', 'âœ… åç«¯APIè¿æ¥æ­£å¸¸');
                    
                    // è¯»å–SSEå“åº”
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        const chunk = decoder.decode(value);
                        log(`æ”¶åˆ°å“åº”: ${chunk}`);
                    }
                } else {
                    log(`åç«¯APIå“åº”å¼‚å¸¸: ${response.status}`);
                    updateStatus('api-status', 'error', 'âŒ åç«¯APIè¿æ¥å¤±è´¥');
                }
                
            } catch (error) {
                log(`åç«¯APIæµ‹è¯•å¤±è´¥: ${error.message}`);
                updateStatus('api-status', 'error', 'âŒ åç«¯APIè¿æ¥å¤±è´¥');
            }
        }
        
        function testFrontendPage() {
            log('æ‰“å¼€AIé€‰æˆ¿é¡µé¢è¿›è¡Œæµ‹è¯•...');
            window.open('http://localhost:5173/ai-rooms', '_blank');
            updateStatus('frontend-status', 'success', 'âœ… å·²æ‰“å¼€AIé€‰æˆ¿é¡µé¢');
        }
        
        function checkPageElements() {
            log('æ£€æŸ¥é¡µé¢å…ƒç´ ...');
            
            // è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤šçš„é¡µé¢å…ƒç´ æ£€æŸ¥é€»è¾‘
            const elements = [
                'dify-chat-wrapper',
                'dify-loading',
                'fallback-chat'
            ];
            
            let allFound = true;
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    log(`âœ… æ‰¾åˆ°å…ƒç´ : ${id}`);
                } else {
                    log(`âŒ æœªæ‰¾åˆ°å…ƒç´ : ${id}`);
                    allFound = false;
                }
            });
            
            if (allFound) {
                updateStatus('frontend-status', 'success', 'âœ… é¡µé¢å…ƒç´ æ£€æŸ¥é€šè¿‡');
            } else {
                updateStatus('frontend-status', 'error', 'âŒ é¡µé¢å…ƒç´ æ£€æŸ¥å¤±è´¥');
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨å¼€å§‹åŸºç¡€æµ‹è¯•
        window.onload = function() {
            log('æµ‹è¯•å·¥å…·åŠ è½½å®Œæˆ');
            log('è¯·ç‚¹å‡»ç›¸åº”æŒ‰é’®å¼€å§‹æµ‹è¯•');
        };
    </script>
</body>
</html>
